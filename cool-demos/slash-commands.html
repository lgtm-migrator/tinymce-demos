<!--
    This demo showcases how to use the autocompleter plugin to make a
    slash commands feature and wrap it in a custom plugin

    Learn more about making custom plugins at https://www.tiny.cloud/docs/advanced/creating-a-plugin/

    Please note this demo contains premium features
-->

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Slash commands plugin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tiny.cloud/1/qagffr3pkuv17a8on1afax661irst1hbr4e6tbv888sz91jc/tinymce/5-dev/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Register a TinyMCE plugin
        // https://www.tiny.cloud/docs/advanced/creating-a-plugin/#registeringacustompluginwithtinymce
        tinymce.PluginManager.add('commandpalette', function (editor) {

            // Instead of defining a custom icon pack, we can register individual
            // icons using the API.
            // https://www.tiny.cloud/docs/api/tinymce.editor.ui/tinymce.editor.ui.registry/#addicon
            editor.ui.registry.addIcon('mention', '<svg width="21" height="20" xmlns="http://www.w3.org/2000/svg"><g><path d="M10.083 9.126a.207.207 0 0 0 .073-.195.21.21 0 0 0-.133-.161l-.442-.162-.523-.191a.488.488 0 0 1-.115-.258 2.19 2.19 0 0 1 .049-1.083 4.682 4.682 0 0 0 1.221-3.595C10.213 1.463 8.898 0 7.083 0c-1.814 0-3.13 1.463-3.13 3.478a4.667 4.667 0 0 0 1.214 3.58c.117.355.138.734.06 1.099a.493.493 0 0 1-.113.255l-.526.195c-2.039.75-3.511 1.29-3.961 2.189A7.633 7.633 0 0 0 0 13.75c0 .23.187.417.417.417h6.91a.208.208 0 0 0 .208-.19 7.063 7.063 0 0 1 2.548-4.851zm4.437-.376a5.632 5.632 0 0 0-5.622 6.928 5.56 5.56 0 0 0 4.155 4.167 5.72 5.72 0 0 0 2.769-.037.833.833 0 0 0 .591-1.019.823.823 0 0 0-.866-.6.795.795 0 0 0-.154.01 4.193 4.193 0 0 1-1.967.022 3.937 3.937 0 0 1-2.903-2.913 4 4 0 0 1 .789-3.444 3.934 3.934 0 0 1 3.166-1.449 4.078 4.078 0 0 1 3.834 3.934c0 .083.022.157.022.238v.683a.667.667 0 0 1-1.328 0v-.896a2.63 2.63 0 1 0-2.63 2.63c.43 0 .852-.109 1.23-.314a.207.207 0 0 1 .26.052c.282.34.654.595 1.075.733.234.082.48.126.729.128a2.333 2.333 0 0 0 2.333-2.333v-.676A5.777 5.777 0 0 0 14.52 8.75zm-.145 6.583a.964.964 0 1 1 .963-.964.964.964 0 0 1-.963.97v-.006z"/></g></svg>')

            // An array holding all unique details of each menu item in the
            // slash commands menu which is later fed into the autocompleter API.
            var insertActions = [
                {
                    text: 'Heading 1',
                    icon: 'h1',
                    action: () => {
                        // Declare what content to be inserted, or what command to execute.
                        // https://www.tiny.cloud/docs/api/tinymce/tinymce.editor/#insertcontent
                        // https://www.tiny.cloud/docs/api/tinymce/tinymce.editor/#execcommand
                        editor.insertContent('<h1>Heading 1</h1>');

                        // Certain actions, like headings, inserts a placeholder to provide some user feedback
                        // But since the placeholder is meant to be replaced
                        // we can force TinyMCE to select the placeholder so the user can just begin
                        // typing their heading
                        // https://www.tiny.cloud/docs/api/tinymce.dom/tinymce.dom.selection/
                        editor.selection.select(editor.selection.getNode());
                    }
                },
                {
                    text: 'Heading 2',
                    icon: 'h2',
                    action: () => {
                        editor.insertContent('<h2>Heading 2</h2>');
                        editor.selection.select(editor.selection.getNode());
                    }
                },
                {
                    text: 'Heading 3',
                    icon: 'h3',
                    action: () => {
                        editor.insertContent('<h3>Heading 3</h3>');
                        editor.selection.select(editor.selection.getNode());
                    }
                },
                {
                    text: 'Bulleted list',
                    plugin: 'lists',
                    icon: 'unordered-list',
                    action: () => editor.execCommand('InsertUnorderedList')
                },
                {
                    text: 'Numbered list',
                    plugin: 'lists',
                    icon: 'ordered-list',
                    action: () => editor.execCommand('InsertOrderedList')
                },
                {
                    text: 'Checklist',
                    plugin: 'checklist',
                    icon: 'checklist',
                    action: () => editor.execCommand('InsertUnorderedList', false, { 'list-attributes': { class: 'tox-checklist' } }) // TODO: this command does not delete command characters
                },
                {
                    type: 'separator'
                },
                {
                    text: 'Current time',
                    plugin: 'insertdatetime',
                    icon: 'insert-time',
                    action: () => editor.execCommand('mceInsertTime')
                },
                {
                    text: 'Current date',
                    plugin: 'insertdatetime',
                    icon: 'insert-time',
                    action: () => editor.execCommand('mceInsertDate')
                },
                {
                    type: 'separator'
                },
                {
                    text: 'Divider',
                    plugin: 'hr',
                    icon: 'horizontal-rule',
                    action: () => editor.execCommand('InsertHorizontalRule')
                },
                {
                    text: 'Table',
                    plugin: 'table',
                    icon: 'table',
                    action: () => editor.execCommand('mceInsertTable', false, { rows: 3, columns: 2, options: { headerRows: 1 } })
                },
                {
                    text: 'Table of contents',
                    plugin: 'toc',
                    icon: 'toc',
                    action: () => editor.execCommand('mceInsertToc')
                },
                {
                    text: 'Image...',
                    plugin: 'image',
                    icon: 'image',
                    action: () => editor.execCommand('mceImage')
                },
                {
                    text: 'Media...',
                    plugin: 'media',
                    icon: 'embed',
                    action: () => editor.execCommand('mceMedia')
                },
                {
                    text: 'Quote',
                    icon: 'quote',
                    action: () => editor.execCommand('mceBlockQuote')
                },
                {
                    text: 'Code block...',
                    icon: 'code-sample',
                    action: () => editor.execCommand('CodeSample')
                },
            ]

            // Set up the autocompleter
            // https://www.tiny.cloud/docs/ui-components/autocompleter/
            editor.ui.registry.addAutocompleter('insertActions', {

                // The character to trigger the autocompleter,
                // the number of characters to type before displaying the autocompleter menu and,
                // configure the autocompleter to display a menu opposed a row of icons
                // https://www.tiny.cloud/docs/ui-components/autocompleter/#configurationoptions
                ch: '/',
                minChars: 0,
                columns: 1,

                // The fetch function is called when the trigger char is pressed
                // and the matches predicate returns true.
                // In other words, this function (re)builds the menu as the user type.
                fetch: function (pattern) {

                    const matchedActions = insertActions.filter((action) => {
                        // Normalize the input to match the same action regardless if
                        // the end-user used upper or lowercase.
                        return (
                            action.type === 'separator' ||
                            action.text.toLowerCase().indexOf(pattern.toLowerCase()) !== -1
                        );
                    }).filter((action, i, actions) => {
                        // As the end-user filters the list, separators can end up adjacent
                        // to each other which looks bad. This function resolves that
                        const prevAction = actions[i - 1];
                        const nextAction = actions[i + 1];
                        const isRedundantSeparator = action.type === 'separator' && (
                            !prevAction ||
                            !nextAction ||
                            prevAction.type === 'separator' ||
                            nextAction.type === 'separator'
                        );
                        return !isRedundantSeparator;
                    });

                    // Here the matched autocompleter objects are built
                    // https://www.tiny.cloud/docs/ui-components/autocompleter/#autocompleteitem
                    return new tinymce.util.Promise(function (resolve) {
                        var results = matchedActions.map(function (action) {
                            return {
                                meta: action,
                                text: action.text,
                                icon: action.icon,
                                value: action.text,
                                type: action.type
                            }
                        });
                        resolve(results);
                    });
                },

                // Perform the action the end-user selected from the autocompleter menu
                // https://www.tiny.cloud/docs/ui-components/autocompleter/#configurationoptions
                onAction: function (autocompleteApi, rng, action, meta) {

                    // In this use-case we want to remove the trigger character and any
                    // further characters the user typed to filter the actions.
                    // We begin by creating a selection around those characters
                    // https://www.tiny.cloud/docs/api/tinymce.dom/tinymce.dom.selection/
                    editor.selection.setRng(rng);

                    // Delete the selection
                    // https://www.tiny.cloud/docs/api/tinymce/tinymce.editor/#execcommand
                    editor.execCommand('Delete');

                    // Perform the selected action
                    meta.action();

                    // Finally we hide the autocompleter menu
                    // https://www.tiny.cloud/docs/ui-components/autocompleter/#api
                    autocompleteApi.hide();
                }
            });

            return {};
        });

        tinymce.init({
            selector: "textarea",
            // Remember to include all relevant plugins here which you included in your `insertActions` array above
            plugins: "commandpalette insertdatetime lists link code table toc hr image codesample media checklist",
            height: 400,
        });
    </script>
    <style>
        body {
            margin: auto;
        }

        body > div {
            margin: 2rem auto;
            max-width: 840px;
        }
    </style>
</head>
<body>
    <div>
        <textarea id="editor">
            <p><strong>Slash commands demo</strong>. Type&nbsp;<code>/</code>&nbsp;to open up a menu to quickly insert different stuff</p>
        </textarea>
    </div>
</body>
</html>
